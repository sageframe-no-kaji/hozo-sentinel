{% extends "base.html" %}
{% block title %}H≈çz≈ç Dashboard{% endblock %}
{% block content %}
<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-bold">Backup Jobs</h1>
  <a href="/jobs/new"
     class="btn-primary text-xs px-4 py-2 rounded text-white cursor-pointer">
    + New Job
  </a>
</div>

<!-- Job cards ‚Äî auto-refreshed every 15s via HTMX -->
<div id="job-cards"
     hx-get="/partials/jobs"
     hx-trigger="every 15s"
     hx-swap="innerHTML">
  {% for job in jobs %}
  <div class="card p-5 mb-4">
    <div class="flex items-start justify-between mb-3">
      <div>
        <h2 class="text-lg font-semibold">{{ job.name }}</h2>
        {% if job.description %}<p class="text-slate-400 text-sm mt-0.5">{{ job.description }}</p>{% endif %}
      </div>
      <span class="text-xs px-2 py-1 rounded
        {% if job.last_result %}
          {% if job.last_result.success %}badge-ok{% else %}badge-err{% endif %}
        {% else %}badge-nil{% endif %}">
        {% if job.last_result %}
          {% if job.last_result.success %}‚úì OK{% else %}‚úó Failed{% endif %}
        {% else %}‚Äî No runs yet{% endif %}
      </span>
    </div>

    <div class="grid grid-cols-2 gap-2 text-sm text-slate-300 mb-4">
      <div><span class="text-slate-500">Source:</span> {{ job.source }}</div>
      <div><span class="text-slate-500">Target:</span> {{ job.target_host }}:{{ job.target_dataset }}</div>
      {% if job.last_result %}
      <div><span class="text-slate-500">Last run:</span> {{ job.last_result.started_at.strftime('%Y-%m-%d %H:%M') }}</div>
      <div><span class="text-slate-500">Duration:</span>
        {% if job.last_result.duration_seconds %}{{ "%.1f"|format(job.last_result.duration_seconds) }}s{% else %}‚Äî{% endif %}
      </div>
      <div><span class="text-slate-500">Snapshots:</span> {{ job.last_result.snapshots_after|length }}</div>
      {% if job.last_result.error %}
      <div class="col-span-2 text-red-400 text-xs mt-1">{{ job.last_result.error }}</div>
      {% endif %}
      {% endif %}
    </div>

    <div class="flex gap-2 flex-wrap">
      <button class="btn-warn text-xs px-3 py-1.5 rounded cursor-pointer text-white"
              hx-post="/wake"
              hx-vals='{"job_name": "{{ job.name }}"}'
              hx-target="#toast"
              hx-swap="innerHTML">
        ‚ö° Wake
      </button>
      <button class="btn-primary text-xs px-3 py-1.5 rounded cursor-pointer text-white"
              hx-post="/run_backup"
              hx-vals='{"job_name": "{{ job.name }}"}'
              hx-target="#toast"
              hx-swap="innerHTML">
        ‚ñ∂ Run Backup
      </button>
      <button class="btn-danger text-xs px-3 py-1.5 rounded cursor-pointer text-white"
              hx-post="/shutdown"
              hx-vals='{"job_name": "{{ job.name }}"}'
              hx-target="#toast"
              hx-swap="innerHTML"
              onclick="return confirm('Shutdown remote host for {{job.name}}?')">
        ‚èª Shutdown
      </button>
      <a href="/jobs/{{ job.name }}/edit"
         class="text-xs px-3 py-1.5 rounded text-slate-300 border border-slate-600 hover:border-slate-400">
        ‚úè Edit
      </a>
      <form method="post" action="/jobs/{{ job.name }}/delete"
            onsubmit="return confirm('Delete job {{ job.name }}? This cannot be undone.')">
        <button type="submit"
                class="text-xs px-3 py-1.5 rounded text-slate-400 border border-slate-700 hover:border-red-700 hover:text-red-400 cursor-pointer bg-transparent">
          üóë Delete
        </button>
      </form>
    </div>
  </div>
  {% else %}
  <div class="card p-8 text-center text-slate-500">
    <p>No jobs configured.</p>
    <p class="text-sm mt-2">Edit your <code>config.yaml</code> and restart H≈çz≈ç.</p>
  </div>
  {% endfor %}
</div>

<!-- Toast notification area -->
<div id="toast" class="fixed bottom-6 right-6 text-sm max-w-xs"></div>

<script>
  // Auto-clear toast after 4s
  document.body.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.detail.target.id === 'toast') {
      setTimeout(() => evt.detail.target.innerHTML = '', 4000);
    }
  });
</script>
{% endblock %}
